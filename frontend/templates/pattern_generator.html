{% extends "base.html" %}
{% block content %}
<div class="container" style="max-width: 760px;">
    <h1>Pattern Generator</h1>

    <label for="screen_select">Screen</label>
    <select id="screen_select" style="display:block; margin: 8px 0 16px; padding: 8px; width: 320px;"></select>

    <div style="display:flex; gap:8px; flex-wrap: wrap; margin-bottom: 16px;">
        <button onclick="takeControl()">Take Display Control</button>
        <button onclick="releaseControl()">Release Display Control</button>
        <button onclick="startPattern()">Start</button>
        <button onclick="stopPattern()">Stop</button>
    </div>

    <label for="color_picker">Colour</label>
    <input id="color_picker" type="color" value="#ffffff" style="display:block; width:120px; height:48px; border:none; padding:0; background:none; margin:8px 0;" />
    <button onclick="showColor()">Display Full Screen Colour (KMS)</button>

    <pre id="status" style="margin-top: 16px; background:#111; color:#eee; padding: 12px; border-radius: 6px; min-height: 52px;">Loading outputsâ€¦</pre>
</div>

<script>
const screenSelect = document.getElementById('screen_select');

function setStatus(message) {
    document.getElementById('status').textContent = message;
}

function selectedConnectorId() {
    return Number(screenSelect.value);
}

async function postJson(url, payload = {}) {
    const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    const body = await response.json().catch(() => ({}));
    if (!response.ok) {
        throw new Error(body.error || `Request failed (${response.status})`);
    }
    return body;
}

async function loadOutputs() {
    try {
        const response = await fetch('/pattern/outputs');
        const outputs = await response.json();

        const usable = outputs.filter(o => o.connected && o.connector_id !== null);
        screenSelect.innerHTML = '';

        usable.forEach((output, index) => {
            const option = document.createElement('option');
            option.value = output.connector_id;
            option.textContent = `${output.name} (id ${output.connector_id})`;
            if (index === 0) option.selected = true;
            screenSelect.appendChild(option);
        });

        if (usable.length === 0) {
            const option = document.createElement('option');
            option.value = '33';
            option.textContent = 'No connected outputs with connector_id found (fallback id 33)';
            screenSelect.appendChild(option);
        }

        setStatus('Outputs loaded.');
    } catch (err) {
        setStatus(`Error loading outputs: ${err.message}`);
    }
}

async function takeControl() {
    const connector_id = selectedConnectorId();
    try {
        await postJson('/pattern/control', { action: 'take', connector_id });
        setStatus(`Display control taken for connector ${connector_id}.`);
    } catch (err) {
        setStatus(`Error: ${err.message}`);
    }
}

async function releaseControl() {
    const connector_id = selectedConnectorId();
    try {
        await postJson('/pattern/control', { action: 'release', connector_id });
        setStatus(`Display control released for connector ${connector_id}.`);
    } catch (err) {
        setStatus(`Error: ${err.message}`);
    }
}

async function startPattern() {
    const connector_id = selectedConnectorId();
    try {
        await postJson('/pattern/start', { connector_id });
        setStatus(`Pattern started on connector ${connector_id}.`);
    } catch (err) {
        setStatus(`Error: ${err.message}`);
    }
}

async function stopPattern() {
    const connector_id = selectedConnectorId();
    try {
        await postJson('/pattern/stop', { connector_id });
        setStatus(`Pattern stopped on connector ${connector_id}.`);
    } catch (err) {
        setStatus(`Error: ${err.message}`);
    }
}

async function showColor() {
    const connector_id = selectedConnectorId();
    const color = document.getElementById('color_picker').value;

    try {
        await postJson('/pattern/start', { connector_id, color, mode: 'solid' });
        setStatus(`Requested colour ${color} on connector ${connector_id} via KMS process.`);
    } catch (err) {
        setStatus(`Error: ${err.message}`);
    }
}

loadOutputs();
</script>
{% endblock %}
