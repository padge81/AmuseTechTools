{% extends "base.html" %}
{% block content %}

<div class="page">

    <!-- ============================= -->
    <!-- Top navigation -->
    <!-- ============================= -->
<div class="top-nav">
    <img src="/static/images/btn-back.png" class="nav-btn" onclick="navBack()">

    <h1 class="page-title">EDID Tools</h1>

    <img src="/static/images/btn-home.png" class="nav-btn" onclick="navHome()">
</div>

<img src="/static/images/divider.png" class="divider">

    <!-- ============================= -->
    <!-- EDID Controls -->
    <!-- ============================= -->
    <div class="controls">

        <div class="control-group">
			<h3>Select Port</h3>
            <label for="port">Select port:</label>
            <select id="port" name="port">
                <!-- populated by JS -->
            </select>

            <button onclick="loadConnectors(true)">↻</button>
        </div>
		
<img src="/static/images/divider.png" class="divider">

        <div class="control-group">
			<h3>Read from Device</h3>
            <button onclick="readEdid()">Read EDID</button>
            <button onclick="resetView()">↻</button>
        </div>

    </div>

    <!-- ============================= -->
    <!-- Status / Match -->
    <!-- ============================= -->
    <div id="status" class="status">Idle</div>
    <div id="match" class="match"></div>

    <!-- ============================= -->
    <!-- EDID Output -->
    <!-- ============================= -->
    <pre id="output" class="output"></pre>

    <!-- ============================= -->
    <!-- View Mode Toggle -->
    <!-- ============================= -->
	<div class="toggle-row">
		<div class="toggle-pill">
			<input
				type="radio"
				id="viewBinary"
				name="viewMode"
				value="binary"
				checked
				onchange="switchView()"
			>
			<label for="viewBinary">Binary</label>

			<input
				type="radio"
				id="viewDecoded"
				name="viewMode"
				value="decoded"
				onchange="switchView()"
			>
			<label for="viewDecoded">Decoded</label>
		</div>
	</div>
	
<img src="/static/images/divider.png" class="divider">

    <!-- ============================= -->
    <!-- Save EDID -->
    <!-- ============================= -->
    <div class="save">
		<h3>Save to File</h3>
        <label for="saveFilename">Save as:</label>
        <input
            id="saveFilename"
            type="text"
            placeholder="filename.bin"
        >
        <button
            id="saveBtn"
            onclick="saveEdid()"
            disabled
        >
            Save EDID
        </button>
    </div>
	
<img src="/static/images/divider.png" class="divider">

    <!-- ============================= -->
    <!-- USB Import / Export -->
    <!-- ============================= -->
	<div class="usb-section">
		<h3>USB Import / Export</h3>

		<div class="usb-controls">
			<label for="port">Select USB device:</label>
			<select id="usbDrive"></select>
			<button onclick="loadUsbDrives()">↻</button>
		</div>

		<div id="usbFiles" class="usb-files"></div>

		<div class="usb-actions">
			<button onclick="importEdids()">Import</button>
			<button onclick="exportEdids()">Export</button>
		</div>

		<div id="usbStatus" class="status"></div>
	</div>
	
<img src="/static/images/divider.png" class="divider">

    <!-- ============================= -->
    <!-- USB Import / Export -->
    <!-- ============================= -->
	<div class="write-section">
		<h3>Write EDID to Device</h3>

		<label>Select file:</label>
		<select id="edidFile" onchange="onFileSelect()">
			<option value="">-- select EDID --</option>
		</select>

		<button id="writeBtn" onclick="writeEdid()" disabled>
			⚠ Write EDID
		</button>
	</div>

</div>

<!-- ============================= -->
<!-- Scripts -->
<!-- ============================= -->
<script src="{{ url_for('static', filename='js/edid.js') }}"></script>

<script>
  function oskShow() { fetch('/system/osk/show', { method: 'POST' }).catch(() => {}); }
  function oskHide() { fetch('/system/osk/hide', { method: 'POST' }).catch(() => {}); }

  function isTextEntry(el) {
    if (!el) return false;
    if (el.tagName === 'TEXTAREA') return true;
    if (el.tagName !== 'INPUT') return false;
    const t = (el.getAttribute('type') || 'text').toLowerCase();
    return ['text','number','password','email','search','tel','url'].includes(t);
  }

  document.addEventListener('focusin', (e) => {
    if (isTextEntry(e.target)) oskShow();
  });

  document.addEventListener('focusout', () => {
    setTimeout(() => {
      if (!isTextEntry(document.activeElement)) oskHide();
    }, 0);
  });

  // Helps on some touch setups where focus doesn't fire reliably on first tap
  document.addEventListener('pointerdown', (e) => {
    if (isTextEntry(e.target)) oskShow();
  });
</script>
{% endblock %}
